# 基于字符命令界面的文本编辑器 - 架构设计文档

## 一、系统架构

### 1.1 模块划分

本系统采用分层架构设计，主要分为以下几个模块：

```
┌─────────────────────────────────────────┐
│          主程序层 (main.py)              │
│      - 用户交互界面                      │
│      - 命令循环                          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│      命令处理层 (command_parser.py)      │
│      - 命令解析                          │
│      - 命令执行                          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│      工作区层 (workspace.py)             │
│      - 编辑器管理                        │
│      - 状态持久化                        │
│      - 日志管理                          │
└──────┬──────────────────┬────────────────┘
       │                  │
┌──────▼──────┐  ┌────────▼──────────┐
│  编辑器层   │  │   日志层          │
│ (TextEditor)│  │ (logging_module)  │
│             │  │                   │
│ - 文本操作  │  │ - 日志记录        │
│ - 文件I/O   │  │ - 观察者模式      │
└──────┬──────┘  └───────────────────┘
       │
┌──────▼──────┐
│  命令层     │
│ (command.py)│
│             │
│ - 命令模式  │
│ - undo/redo │
└─────────────┘
```

### 1.2 模块职责说明

#### 1.2.1 主程序层 (main.py)
- **职责**：程序入口，处理用户交互
- **功能**：
  - 显示提示符
  - 接收用户输入
  - 调用命令执行器
  - 显示执行结果

#### 1.2.2 命令处理层 (command_parser.py)
- **职责**：解析和执行用户命令
- **功能**：
  - 解析命令字符串
  - 提取命令参数
  - 分发到对应的处理函数
  - 处理异常和错误

#### 1.2.3 工作区层 (workspace.py)
- **职责**：管理全局状态和编辑器实例
- **功能**：
  - 管理多个打开的编辑器
  - 维护当前活动编辑器
  - 实现状态持久化（备忘录模式）
  - 协调编辑器和日志模块

#### 1.2.4 编辑器层 (text_editor.py)
- **职责**：文本的存储和基本编辑操作
- **功能**：
  - 文本内容存储（行数组）
  - 基本编辑操作（append、insert、delete、replace）
  - 文件读写
  - 修改状态管理

#### 1.2.5 命令层 (command.py)
- **职责**：封装编辑操作为命令对象
- **功能**：
  - 实现命令模式
  - 支持undo/redo
  - 命令的执行、撤销、重做

#### 1.2.6 日志层 (logging_module.py)
- **职责**：记录命令执行日志
- **功能**：
  - 实现观察者模式
  - 记录命令执行日志
  - 日志文件管理

### 1.3 模块依赖关系

```
main.py
  └─> command_parser.py
        └─> workspace.py
              ├─> text_editor.py
              ├─> command.py
              └─> logging_module.py
```

**依赖说明**：
- 上层模块依赖下层模块
- 工作区模块是核心协调模块
- 编辑器、命令、日志模块相对独立，通过工作区模块协调

## 二、核心设计

### 2.1 设计模式应用

#### 2.1.1 命令模式 (Command Pattern)

**应用位置**：`command.py`

**目的**：实现undo/redo功能

**实现方式**：
- 定义`Command`抽象基类，包含`execute()`、`undo()`、`redo()`方法
- 具体命令类（`AppendCommand`、`InsertCommand`、`DeleteCommand`、`ReplaceCommand`）继承`Command`
- 每个命令对象封装一次编辑操作及其撤销所需的信息

**优点**：
- 将操作封装为对象，便于管理
- 支持操作的撤销和重做
- 易于扩展新的命令类型

**代码示例**：
```python
class AppendCommand(Command):
    def __init__(self, editor, text):
        self._editor = editor
        self._text = text
        self._original_line_count = 0
    
    def execute(self):
        self._original_line_count = self._editor.get_line_count()
        self._editor.append(self._text)
    
    def undo(self):
        # 撤销操作
        ...
```

#### 2.1.2 观察者模式 (Observer Pattern)

**应用位置**：`logging_module.py`、`workspace.py`

**目的**：实现日志记录的事件通知机制

**实现方式**：
- 定义`Observer`接口，包含`update()`方法
- `Logger`类实现`Observer`接口
- `EditorWrapper`类维护观察者列表，在执行命令时通知观察者

**优点**：
- 解耦事件发布者和订阅者
- 支持多个观察者
- 易于扩展新的观察者类型

**代码示例**：
```python
class Logger(Observer):
    def update(self, event_type, *args, **kwargs):
        if event_type == 'command_executed':
            command = args[0]
            self._write_log(command)
```

#### 2.1.3 备忘录模式 (Memento Pattern)

**应用位置**：`workspace.py`

**目的**：实现工作区状态的持久化

**实现方式**：
- 定义`WorkspaceMemento`类，保存工作区状态
- `Workspace`类提供`_create_memento()`和`_restore_from_memento()`方法
- 状态保存到`.editor_workspace`文件（JSON格式）

**优点**：
- 保存和恢复状态分离
- 不破坏封装性
- 支持状态回滚

**保存的状态**：
- 已打开的文件列表
- 当前活动文件
- 文件修改状态
- 日志开关状态

**不保存的状态**：
- undo/redo历史记录（临时状态）
- 编辑时长统计

### 2.2 其他设计决策

#### 2.2.1 文本存储方式

**决策**：使用行数组（`List[str]`）存储文本

**理由**：
- 便于按行号定位和操作
- 符合文本编辑器的使用场景
- 插入和删除操作相对高效

#### 2.2.2 文件编码

**决策**：统一使用UTF-8编码

**理由**：
- 支持多语言字符
- 是Python的标准编码
- 跨平台兼容性好

#### 2.2.3 错误处理策略

**决策**：异常处理 + 用户友好提示

**实现**：
- 使用Python异常机制处理错误
- 在命令执行层捕获异常并转换为用户友好的错误消息
- 日志记录失败不中断程序运行

#### 2.2.4 编辑器包装类

**决策**：使用`EditorWrapper`包装`TextEditor`

**理由**：
- 将命令历史（undo/redo栈）与编辑器分离
- 便于管理观察者
- 保持`TextEditor`类的简洁性

## 三、运行说明

### 3.1 使用的编程语言及版本

- **编程语言**：Python 3.7+
- **依赖库**：无第三方库依赖，仅使用Python标准库

### 3.2 安装依赖的步骤

本项目不依赖任何第三方库，使用Python标准库即可运行。

**要求**：
- Python 3.7 或更高版本
- 操作系统：Windows、Linux、macOS均可

### 3.3 运行程序的命令

**启动编辑器**：
```bash
python main.py
```

**运行测试**：
```bash
# 运行所有测试
python -m unittest discover

# 运行特定测试模块
python -m unittest test_text_editor
python -m unittest test_command
python -m unittest test_workspace
python -m unittest test_command_parser
```

### 3.4 使用示例

```bash
# 1. 启动编辑器
python main.py

# 2. 加载文件
> load test.txt

# 3. 追加文本
> append "Hello World"

# 4. 显示内容
> show

# 5. 保存文件
> save

# 6. 退出程序
> exit
```

## 四、测试文档

### 4.1 测试用例列表

#### 4.1.1 文本编辑器测试 (test_text_editor.py)

1. **test_append** - 测试追加文本功能
2. **test_append_multiline** - 测试追加多行文本
3. **test_insert** - 测试插入文本功能
4. **test_insert_at_end** - 测试在行尾插入文本
5. **test_insert_empty_file** - 测试在空文件中插入文本
6. **test_insert_error_empty_file** - 测试插入错误处理
7. **test_delete** - 测试删除文本功能
8. **test_replace** - 测试替换文本功能
9. **test_show** - 测试显示文本功能
10. **test_show_range** - 测试显示指定范围
11. **test_save_and_load** - 测试保存和加载文件
12. **test_modified_flag** - 测试修改标记

#### 4.1.2 命令模式测试 (test_command.py)

1. **test_append_command_undo_redo** - 测试追加命令的撤销和重做
2. **test_insert_command_undo_redo** - 测试插入命令的撤销和重做
3. **test_delete_command_undo_redo** - 测试删除命令的撤销和重做
4. **test_replace_command_undo_redo** - 测试替换命令的撤销和重做

#### 4.1.3 工作区测试 (test_workspace.py)

1. **test_load_file** - 测试加载文件功能
2. **test_init_file** - 测试创建新文件功能
3. **test_save_file** - 测试保存文件功能
4. **test_close_file** - 测试关闭文件功能
5. **test_switch_active_file** - 测试切换活动文件功能
6. **test_list_editors** - 测试列出编辑器功能

#### 4.1.4 命令解析器测试 (test_command_parser.py)

1. **test_parse_simple_command** - 测试解析简单命令
2. **test_parse_command_with_quoted_text** - 测试解析带引号的命令
3. **test_parse_command_with_multiple_args** - 测试解析多个参数的命令
4. **test_parse_line_col** - 测试解析行号:列号
5. **test_parse_line_col_error** - 测试解析错误格式
6. **test_parse_range** - 测试解析范围
7. **test_parse_range_single_line** - 测试解析单行范围

### 4.2 测试执行结果

运行测试命令：
```bash
python -m unittest discover -v
```

**预期输出**：
- 所有测试用例通过
- 测试覆盖主要功能模块
- 验证边界条件和错误处理

## 五、设计亮点

### 5.1 模块化设计

- 清晰的模块划分，每个模块职责单一
- 低耦合高内聚的设计
- 易于测试和维护

### 5.2 设计模式应用

- **命令模式**：优雅地实现undo/redo功能
- **观察者模式**：实现日志记录的事件通知
- **备忘录模式**：实现状态持久化

### 5.3 错误处理

- 完善的异常处理机制
- 用户友好的错误提示
- 日志记录失败不影响程序运行

### 5.4 扩展性

- 易于添加新的命令类型
- 易于添加新的观察者
- 易于扩展新的编辑器类型

## 六、文件结构

```
.
├── main.py                 # 主程序入口
├── text_editor.py          # 文本编辑器模块
├── command.py              # 命令模式实现
├── workspace.py            # 工作区模块
├── command_parser.py       # 命令解析器
├── logging_module.py       # 日志模块
├── test_text_editor.py     # 文本编辑器测试
├── test_command.py         # 命令模式测试
├── test_workspace.py       # 工作区测试
├── test_command_parser.py  # 命令解析器测试
├── README.md               # 项目说明
└── 架构设计文档.md         # 本文档
```

## 七、总结

本系统采用分层架构设计，合理运用了命令模式、观察者模式和备忘录模式，实现了功能完整、结构清晰的文本编辑器。代码具有良好的可读性、可维护性和可扩展性。

